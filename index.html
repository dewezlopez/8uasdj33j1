<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="node_modules/d3/dist/d3.js"></script>
  </head>
  <body>
    <svg
      id="canvas"
      width="900"
      height="900"
      style="border: 1px solid black"
    ></svg>
    <script>
      const data = [
        { name: "t.com", amount: 23934880, type: "core" },
        {
          name: "Telstra Webmail",
          amount: 5194037,
          type: "orbit-near",
          target: "t.com",
        },
        {
          name: "Another example",
          amount: 2000000,
          type: "orbit-near",
          target: "t.com",
        },
        {
          name: "Telstra Enterprise",
          amount: 10846,
          type: "orbit-far",
          target: "t.com",
        },
        {
          name: "Another example 2",
          amount: 5000,
          type: "orbit-far",
          target: "t.com",
        },
        { name: "Telstra Air", amount: 29379, type: "standalone" },
        { name: "Facebook", amount: "na", type: "standalone" },
      ];

      const get_angle = () => Math.random() * Math.PI * 2;

      const size_max = 100;
      const size_min = 10;
      const svg = document.getElementById("canvas");
      const center = [svg.clientWidth / 2, svg.clientHeight / 2];
      const rad_near = 200;
      const rad_far = 300;
      const rad_standalone_min = 380;
      const rad_standalone_max = 430;

      for (const datum in data) {
        const angle = get_angle();
        const obj = data[datum];

        obj.pos_x = (function () {
          if (obj.type == "core") {
            return center[0];
          } else if (obj.type == "orbit-near") {
            return center[0] + Math.cos(angle) * rad_near;
          } else if (obj.type == "orbit-far") {
            return center[0] + Math.cos(angle) * rad_far;
          } else if (obj.type == "standalone") {
            return (
              center[0] +
              Math.cos(angle) *
                (Math.random() * (rad_standalone_max - rad_standalone_min) +
                  rad_standalone_min)
            );
          }
        })();

        obj.pos_y = (function () {
          if (obj.type == "core") {
            return center[1];
          } else if (obj.type == "orbit-near") {
            return center[1] + Math.sin(angle) * rad_near;
          } else if (obj.type == "orbit-far") {
            return center[1] + Math.sin(angle) * rad_far;
          } else if (obj.type == "standalone") {
            return (
              center[0] +
              Math.sin(angle) *
                (Math.random() * (rad_standalone_max - rad_standalone_min) +
                  rad_standalone_min)
            );
          }
        })();
      }

      console.log(data);

      const scale = d3
        .scaleLinear()
        .domain([10000, data[0].amount])
        .range([size_min, size_max]);

      const colourScale = d3
        .scaleLinear()
        .domain([
          1000,
          5000,
          8000,
          12000,
          25000,
          50000,
          100000,
          1000000,
          10000000,
          30000000,
        ])
        .range(d3.schemeSet3);

      function abbreviateNumber(value) {
        // https://stackoverflow.com/a/10601315/1517137
        var newValue = value;
        if (value >= 1000) {
          var suffixes = ["", "K", "M", "B", "T"];
          var suffixNum = Math.floor(("" + value).length / 3);
          var shortValue = "";
          for (var precision = 2; precision >= 1; precision--) {
            shortValue = parseFloat(
              (suffixNum != 0
                ? value / Math.pow(1000, suffixNum)
                : value
              ).toPrecision(precision)
            );
            var dotLessShortValue = (shortValue + "").replace(
              /[^a-zA-Z 0-9]+/g,
              ""
            );
            if (dotLessShortValue.length <= 2) {
              break;
            }
          }
          if (shortValue % 1 != 0) shortValue = shortValue.toFixed(1);
          newValue = shortValue + suffixes[suffixNum];
        }
        return newValue;
      }

      function getScale(amount) {
        if (amount != "na") {
          return amount;
        }
        return 10000;
      }

      const group = d3
        .select("svg")
        .selectAll("g")
        .data(data)
        .join((enter) => enter.append("g"));

      const circles = group
        .append("circle")
        .attr("r", (data) => scale(getScale(data.amount)))
        .attr("cx", (data) => data.pos_x)
        .attr("cy", (data) => data.pos_y)
        .style("stroke", "#000")
        .style("fill", (data) => colourScale(getScale(data.amount)));

      const text = group
        .append("text")
        .attr("dy", "1rem")
        .attr("x", (data) => data.pos_x)
        .attr("y", (data) => data.pos_y + scale(getScale(data.amount)));

      const name_text = text
        .append("tspan")
        .attr("x", (data) => data.pos_x)
        .attr("dy", "1.2rem")
        .attr("text-anchor", "middle")
        .text((data) => data.name);

      const amount_text = text
        .append("tspan")
        .attr("x", (data) => data.pos_x)
        .attr("dy", "1.2rem")
        .attr("text-anchor", "middle")
        .text((data) =>
          data.amount != "na" ? abbreviateNumber(data.amount) : ""
        );

      const orbit1 = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "circle"
      );

      orbit1.setAttribute("cx", center[0]);
      orbit1.setAttribute("cy", center[1]);
      orbit1.setAttribute("r", rad_near);
      orbit1.setAttribute("fill", "none");
      orbit1.setAttribute("stroke", "#ccc");

      svg.prepend(orbit1);

      const orbit2 = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "circle"
      );

      orbit2.setAttribute("cx", center[0]);
      orbit2.setAttribute("cy", center[1]);
      orbit2.setAttribute("r", rad_far);
      orbit2.setAttribute("fill", "none");
      orbit2.setAttribute("stroke", "#ccc");

      svg.prepend(orbit2);
    </script>
  </body>
</html>
