<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="node_modules/d3/dist/d3.js"></script>
    <style>
      .additional {
        display: none;
      }

      g:hover .additional {
        display: block;
      }
    </style>
  </head>
  <body>
    <svg
      id="canvas"
      width="900"
      height="900"
      style="border: 1px solid black"
    ></svg>
    <script>
      const data = [
        {
          name: "Telstra.com",
          amount: 16340721,
          orbit: "core",
          type: "Telstra Digital Website",
          additional: "Steve Sibley on AEM",
        },
        {
          name: "Telstra Webmail",
          amount: 305223,
          orbit: "Integrated near",
          type: "Telstra Website",
          additional: "TBC",
        },
        {
          name: "Pre-Paid Recharge (PPR)",
          amount: 1021905,
          orbit: "Integrated near",
          type: "Telstra Website",
          additional: "TBC",
        },
        {
          name: "Crowd Support",
          amount: 636890,
          orbit: "Integrated far",
          type: "Telstra Digital Website",
          additional: "TBC",
        },
        {
          name: "One Place",
          amount: 139553,
          orbit: "Integrated far",
          type: "Telstra Digital Website",
          additional: "TBC",
        },
        {
          name: "Telstra Boost Web",
          amount: 468229,
          orbit: "Standalone",
          type: "Telstra Website",
          additional: "TBC",
        },
        {
          name: "Message Telstra",
          amount: 312393,
          orbit: "Integrated near",
          type: "Telstra Digital Website",
          additional: "TBC",
        },
        {
          name: "Fix.Telstra",
          amount: 274665,
          orbit: "Integrated near",
          type: "Telstra Website",
          additional: "TBC",
        },
        {
          name: "Pre-Paid Activation (PPA)",
          amount: 220681,
          orbit: "Integrated near",
          type: "Telstra Digital Website",
          additional: "TBC",
        },
        {
          name: "AFL",
          amount: 6899,
          orbit: "Standalone",
          type: "Telstra Website",
          additional: "TBC",
        },
        {
          name: "Kayo",
          amount: 39145,
          orbit: "Outer orbit",
          type: "External Website",
          additional: "External",
        },
        {
          name: "Binge",
          amount: 49812,
          orbit: "Outer orbit",
          type: "External Website",
          additional: "External",
        },
        {
          name: "Telstra Outages",
          amount: 290659,
          orbit: "Integrated near",
          type: "Telstra Website",
          additional: "TBC",
        },
        {
          name: "Foxtel",
          amount: 22017,
          orbit: "Standalone",
          type: "External Website",
          additional: "External",
        },
        {
          name: "Telstra Air",
          amount: 27557,
          orbit: "Standalone",
          type: "Telstra Digital Website",
          additional: "TBC",
        },
        {
          name: "Netflix",
          amount: 17615,
          orbit: "Outer orbit",
          type: "External Website",
          additional: "External",
        },
        {
          name: "Telstra TV",
          amount: 9442,
          orbit: "Standalone",
          type: "Telstra Website",
          additional: "TBC",
        },
        {
          name: "Telstra Enterprise",
          amount: 2373,
          orbit: "Integrated far",
          type: "Telstra Website",
          additional: "TBC",
        },
      ];

      const get_angle = () => Math.random() * Math.PI * 2;

      const size_max = 50;
      const size_min = 10;
      const svg = document.getElementById("canvas");
      const center = [svg.clientWidth / 2, svg.clientHeight / 2];
      const rad_near = 150;
      const rad_far = 250;
      const rad_outer = 420;
      const rad_standalone_min = 300;
      const rad_standalone_max = 400;

      // function get_angle(radius = null, type = cos) {
      //   if (radius === null) {
      //     return center[0];
      //   }
      //   return center[0] * Math[type](angle) * radius;
      // }

      for (const datum in data) {
        const angle = get_angle();
        const obj = data[datum];

        obj.pos_x = (function () {
          if (obj.orbit == "core") {
            return center[0];
          } else if (obj.orbit == "Integrated near") {
            return center[0] + Math.cos(angle) * rad_near;
          } else if (obj.orbit == "Integrated far") {
            return center[0] + Math.cos(angle) * rad_far;
          } else if (obj.orbit == "Outer orbit") {
            return center[0] + Math.cos(angle) * rad_outer;
          } else if (obj.orbit == "Standalone") {
            return (
              center[0] +
              Math.cos(angle) *
                (Math.random() * (rad_standalone_max - rad_standalone_min) +
                  rad_standalone_min)
            );
          }
        })();

        obj.pos_y = (function () {
          if (obj.orbit == "core") {
            return center[0];
          } else if (obj.orbit == "Integrated near") {
            return center[0] + Math.sin(angle) * rad_near;
          } else if (obj.orbit == "Integrated far") {
            return center[0] + Math.sin(angle) * rad_far;
          } else if (obj.orbit == "Outer orbit") {
            return center[0] + Math.sin(angle) * rad_outer;
          } else if (obj.orbit == "Standalone") {
            return (
              center[0] +
              Math.sin(angle) *
                (Math.random() * (rad_standalone_max - rad_standalone_min) +
                  rad_standalone_min)
            );
          }
        })();
      }

      console.log(data);

      const scale = d3
        .scaleLinear()
        .domain([10000, data[0].amount])
        .range([size_min, size_max]);

      function getFill(type) {
        switch (type) {
          case "Telstra Digital Website":
            return "#E7685E";
          case "Telstra Website":
            return "#509293";
          case "External Website":
            return "#F6CE4B";
        }
      }

      function abbreviateNumber(value) {
        // https://stackoverflow.com/a/10601315/1517137
        var newValue = value;
        if (value >= 1000) {
          var suffixes = ["", "K", "M", "B", "T"];
          var suffixNum = Math.floor(("" + value).length / 3);
          var shortValue = "";
          for (var precision = 2; precision >= 1; precision--) {
            shortValue = parseFloat(
              (suffixNum != 0
                ? value / Math.pow(1000, suffixNum)
                : value
              ).toPrecision(precision)
            );
            var dotLessShortValue = (shortValue + "").replace(
              /[^a-zA-Z 0-9]+/g,
              ""
            );
            if (dotLessShortValue.length <= 2) {
              break;
            }
          }
          if (shortValue % 1 != 0) shortValue = shortValue.toFixed(1);
          newValue = shortValue + suffixes[suffixNum];
        }
        return newValue;
      }

      function getScale(amount) {
        if (amount != "na") {
          return amount;
        }
        return 10000;
      }

      const group = d3
        .select("svg")
        .selectAll("g")
        .data(data)
        .join((enter) => enter.append("g"));

      const circles = group
        .append("circle")
        .attr("r", (data) => scale(getScale(data.amount)))
        .attr("cx", (data) => data.pos_x)
        .attr("cy", (data) => data.pos_y)
        .style("stroke", "#787878")
        .style("fill", (data) => getFill(data.type));

      const text = group
        .append("text")
        .attr("dy", "1rem")
        .attr("x", (data) => data.pos_x)
        .attr("y", (data) => data.pos_y + scale(getScale(data.amount)));

      text
        .append("tspan")
        .attr("x", (data) => data.pos_x)
        .attr("dy", "1rem")
        .attr("text-anchor", "middle")
        .text(
          (data) =>
            `${data.name} - ${
              data.amount != "na" ? abbreviateNumber(data.amount) : ""
            }`
        );

      const additional_text = group
        .append("text")
        .attr("class", "additional")
        .attr("dy", "1rem")
        .attr("x", (data) => data.pos_x)
        .attr("y", (data) => data.pos_y + 30 + scale(getScale(data.amount)));

      additional_text
        .append("tspan")
        .attr("x", (data) => data.pos_x)
        .attr("dy", "1rem")
        .attr("text-anchor", "middle")
        .text((data) => data.additional);

      const orbit1 = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "circle"
      );

      orbit1.setAttribute("cx", center[0]);
      orbit1.setAttribute("cy", center[1]);
      orbit1.setAttribute("r", rad_near);
      orbit1.setAttribute("fill", "none");
      orbit1.setAttribute("stroke", "#ccc");

      svg.prepend(orbit1);

      const orbit2 = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "circle"
      );

      orbit2.setAttribute("cx", center[0]);
      orbit2.setAttribute("cy", center[1]);
      orbit2.setAttribute("r", rad_far);
      orbit2.setAttribute("fill", "none");
      orbit2.setAttribute("stroke", "#ccc");

      svg.prepend(orbit2);

      const orbit3 = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "circle"
      );

      orbit3.setAttribute("cx", center[0]);
      orbit3.setAttribute("cy", center[1]);
      orbit3.setAttribute("r", rad_outer);
      orbit3.setAttribute("fill", "none");
      orbit3.setAttribute("stroke", "#ccc");

      svg.prepend(orbit3);
    </script>
  </body>
</html>
